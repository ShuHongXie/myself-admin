# 生产环境前端项目 Nginx 配置
# 适配 Vue/React 前端路由，优化性能、安全加固、支持跨域
server {
    # 监听 80 端口（容器内端口，外部通过 docker-compose 映射）
    listen 80;
    # 服务器域名（生产环境可改为实际域名，如 frontend.xxx.com；本地/测试用 localhost）
    server_name 1.12.51.201;

    # 核心：前端静态资源根目录（Docker 容器内路径，和 Dockerfile 一致）
    root /usr/share/nginx/html;
    index index.html index.htm;

    ###########################################################################
    # 1. 前端路由兼容：解决 Vue-Router/React-Router 刷新 404 问题
    ###########################################################################
    location / {
        # 尝试访问请求路径 → 路径目录 → 重定向到 index.html（前端路由接管）
        try_files $uri $uri/ /index.html;
        # 禁止缓存 HTML（避免上线后浏览器缓存旧页面）
        add_header Cache-Control "no-cache, no-store, must-revalidate";
        add_header Pragma "no-cache";
        add_header Expires "0";
    }

    ###########################################################################
    # 2. 静态资源优化：缓存策略 + 压缩 + 防盗链
    ###########################################################################
    # 匹配静态资源（js、css、图片、字体等）
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|webp|woff|woff2|ttf|otf)$ {
        # 长期缓存（30 天），基于文件哈希值更新（前端打包时给文件名加 hash 即可）
        expires 30d;
        add_header Cache-Control "public, max-age=2592000";
        # 防盗链：只允许自身域名和 CDN 访问（替换为你的实际域名，多个用空格分隔）
        valid_referers none blocked localhost 127.0.0.1 frontend.xxx.com;
        if ($invalid_referer) {
            return 403; # 非法引用返回 403
        }
    }

    ###########################################################################
    # 3. Gzip 压缩：减小传输体积，提升加载速度
    ###########################################################################
    gzip on;
    gzip_vary on; # 告诉浏览器支持 gzip 压缩
    gzip_proxied any;
    gzip_comp_level 6; # 压缩级别（1-9，越高压缩率越高但消耗 CPU 越多，6 为平衡值）
    gzip_buffers 16 8k;
    gzip_http_version 1.1;
    # 压缩文件类型（覆盖前端常见静态资源）
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;

    ###########################################################################
    # 4. 安全加固：防止常见漏洞
    ###########################################################################
    # 禁止访问隐藏文件（.git、.env、.npmrc 等敏感文件）
    location ~ /\.(git|svn|hg|env|npmrc|idea|vscode) {
        deny all;
        return 403;
    }
    # 禁止目录遍历
    autoindex off;
    # 限制请求方法（只允许 GET/HEAD/POST，禁止 PUT/DELETE 等）
    if ($request_method !~ ^(GET|HEAD|POST)$) {
        return 405;
    }
    # 添加安全响应头
    add_header X-Frame-Options "SAMEORIGIN"; # 防止点击劫持（只允许同源嵌套）
    add_header X-XSS-Protection "1; mode=block"; # 防御 XSS 攻击
    add_header X-Content-Type-Options "nosniff"; # 防止 MIME 类型嗅探
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always; # HTTPS 强制跳转（后续配置 HTTPS 时生效）

    ###########################################################################
    # 5. 跨域配置：如果前端需要直接请求后端接口，启用以下配置（按需修改）
    ###########################################################################
    # location /api/ {
    #     # 后端接口地址（替换为你的实际后端接口域名）
    #     proxy_pass https://api.xxx.com/;
    #     # 传递真实客户端 IP
    #     proxy_set_header X-Real-IP $remote_addr;
    #     proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    #     proxy_set_header Host $host;
    #     proxy_set_header X-Forwarded-Proto $scheme;
    #     # 跨域允许配置
    #     add_header Access-Control-Allow-Origin "https://frontend.xxx.com"; # 允许的前端域名（生产环境建议精准配置，不要用 *）
    #     add_header Access-Control-Allow-Methods "GET, POST, OPTIONS";
    #     add_header Access-Control-Allow-Headers "Content-Type, Authorization";
    #     add_header Access-Control-Allow-Credentials "true";
    #     # 处理 OPTIONS 预检请求
    #     if ($request_method = OPTIONS) {
    #         return 204;
    #     }
    # }

    ###########################################################################
    # 6. 日志配置：记录访问日志，方便排查问题
    ###########################################################################
    # 日志格式定义（包含时间、IP、请求方法、状态码、耗时等关键信息）
    log_format access_log_format '$time_local [$remote_addr] "$request" '
                                 '$status $body_bytes_sent "$http_referer" '
                                 '"$http_user_agent" "$http_x_forwarded_for" '
                                 '$request_time';
    # 访问日志路径（容器内路径，可通过 docker-compose 挂载到宿主机，避免容器删除后日志丢失）
    access_log /var/log/nginx/frontend-access.log access_log_format;
    # 错误日志路径
    error_log /var/log/nginx/frontend-error.log warn;

    ###########################################################################
    # 7. 错误页面配置：统一跳转到前端 index.html，保持用户体验一致
    ###########################################################################
    error_page 404 /index.html;
    error_page 403 /index.html;
    error_page 500 502 503 504 /index.html;
}
