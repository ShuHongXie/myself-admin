# æ„å»ºé˜¶æ®µï¼ˆwebå­åŒ…ä¸“å±ï¼Œé€‚é…WORKSPACE=miniloï¼‰
FROM node:20-alpine as build-stage
RUN set -e  # é‡åˆ°é”™è¯¯ç«‹å³é€€å‡ºï¼Œé¿å…æ„å»ºé™é»˜å¤±è´¥
# é…ç½®pnpmï¼ˆalpineé•œåƒéœ€ç¡®ä¿corepackå¯ç”¨ï¼‰
RUN corepack enable && corepack prepare pnpm@latest --activate
WORKDIR /app

# ä»…ä¿ç•™æ„å»ºç¯å¢ƒå‚æ•°ï¼ˆtest/prodï¼‰
ARG BUILD_ENV=prod

# æ–°å¢ï¼šæå‰åˆ›å»ºé•œåƒå†…çš„apps/webç›®å½•ï¼ˆé¿å…COPYæ—¶ç›®å½•ä¸å­˜åœ¨ï¼‰
RUN mkdir -p ./apps/web/

# å¤åˆ¶workspaceæ ¸å¿ƒæ–‡ä»¶ï¼ˆå…³é”®ï¼šBUILD_CONTEXTæ˜¯miniloï¼Œæ ¹é…ç½®åœ¨WORKSPACEä¸‹ï¼Œæ— éœ€../ï¼‰
COPY pnpm-workspace.yaml ./
COPY package.json ./
COPY pnpm-lock.yaml ./

# ä¿®å¤ï¼šåˆ é™¤minilo/å‰ç¼€ï¼ˆå› ä¸ºBUILD_CONTEXTå·²ç»æ˜¯miniloï¼‰
COPY apps/web/package*.json ./apps/web/

# ä»…å®‰è£…webå­åŒ…çš„ä¾èµ–ï¼ˆå…³é”®ä¿®å¤ç‚¹ğŸ‘‡ï¼‰
# 1. --filter=apps/web...ï¼šå®‰è£…webå­åŒ…åŠå…¶æ‰€æœ‰ä¾èµ–é“¾
# 2. --prod=falseï¼šå¼ºåˆ¶å®‰è£…devDependenciesï¼ˆåŒ…å«viteï¼‰
# 3. ä¿ç•™åŸæœ‰å‚æ•°ï¼šé”æ–‡ä»¶ã€å›½å†…æºã€ä¸ç¼“å­˜
RUN pnpm install \
  --filter=apps/web... \
  --frozen-lockfile \
  --registry=https://registry.npmmirror.com \
  --no-cache \
  --prod=false

# ä¿®å¤ï¼šå¤åˆ¶webå­åŒ…ä»£ç ï¼ˆåˆ é™¤minilo/å‰ç¼€ï¼‰
COPY apps/web/ ./apps/web/

# è¿›å…¥webå­åŒ…ç›®å½•æ‰§è¡Œæ‰“åŒ…ï¼ˆè·¯å¾„åŒæ­¥ä¿®æ”¹ï¼‰
WORKDIR /app/apps/web
RUN echo "å½“å‰æ„å»ºwebå­åŒ…ç¯å¢ƒ: ${BUILD_ENV}"
# ä¿®å¤ï¼šç¡®ä¿pnpm runè°ƒç”¨å±€éƒ¨viteï¼Œé¿å…è·¯å¾„é—®é¢˜
RUN if [ "${BUILD_ENV}" = "test" ]; then \
        pnpm run build:test; \
    else \
        pnpm run build:prod; \
    fi

# è¿è¡Œé˜¶æ®µï¼ˆnginxï¼Œwebä¸“å±ï¼‰
FROM nginx:alpine as production-stage
ARG BUILD_ENV=prod
# ä¿®å¤ï¼šé•œåƒå†…äº§ç‰©è·¯å¾„æ”¹ä¸º/app/apps/web/distï¼ˆåŒæ­¥ä¸Šé¢çš„WORKDIRï¼‰
COPY --from=build-stage /app/apps/web/dist /usr/share/nginx/html
# å¤åˆ¶å¯¹åº”ç¯å¢ƒçš„nginxé…ç½®ï¼ˆå¯é€‰ï¼šæŒ‰ç¯å¢ƒåŒºåˆ†ï¼‰
# æ³¨æ„ï¼šéœ€ç¡®ä¿å®¿ä¸»æœºæœ‰nginx-test.conf/nginx-prod.confæ–‡ä»¶ï¼Œå¦åˆ™ä¼šæŠ¥é”™
COPY nginx-${BUILD_ENV}.conf /etc/nginx/conf.d/default.conf
EXPOSE 80
CMD ["nginx", "-g", "daemon off;"]