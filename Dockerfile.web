# 构建阶段（web子包专属，适配WORKSPACE=minilo）
FROM node:20-alpine as build-stage
RUN set -e
RUN corepack enable && corepack prepare pnpm@latest --activate
WORKDIR /app

ARG BUILD_ENV=prod
ARG BUILD_NAME=prod


# 复制workspace核心文件
COPY pnpm-workspace.yaml ./
COPY package.json ./
COPY pnpm-lock.yaml ./

# 复制所有子包的 package.json（包括 apps 和 packages）
COPY apps/web/package*.json ./apps/web/
# 【关键修复】复制所有 packages 的 package.json，因为 web 依赖它们
COPY packages/core/ ./packages/core/
COPY packages/locales/ ./packages/locales/
COPY packages/store/ ./packages/store/
COPY packages/types/ ./packages/types/

# 安装 web 及其依赖链（包括 packages/* 中的内部依赖）
RUN pnpm install \
  --frozen-lockfile \
  --registry=https://registry.npmmirror.com \
  --no-cache \
  --prod=false

# 复制源代码
COPY apps/web/ ./apps/web/
# 【关键修复】复制所有 packages 源码
COPY packages/ ./packages/

# 进入web子包目录执行打包
WORKDIR /app/apps/web
RUN echo "当前构建web子包环境: ${BUILD_ENV}"
RUN if [ "${BUILD_ENV}" = "test" ]; then \
        pnpm run build:test; \
    else \
        pnpm run build:prod; \
    fi

# 运行阶段（nginx）
FROM nginx:alpine as production-stage
ARG BUILD_ENV=prod
COPY --from=build-stage /app/apps/web/dist /usr/share/nginx/html
COPY ${BUILD_NAME}-${BUILD_ENV}.conf /etc/nginx/conf.d/default.conf
EXPOSE 80
CMD ["nginx", "-g", "daemon off;"]