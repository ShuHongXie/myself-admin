# 构建阶段（web子包专属）
FROM node:20-alpine as build-stage
RUN set -e
# 配置pnpm
RUN corepack enable && corepack prepare pnpm@latest --activate
WORKDIR /app

# 仅保留构建环境参数（test/prod）
ARG BUILD_ENV=prod

# 复制workspace核心文件（根目录配置）
COPY pnpm-workspace.yaml ./
COPY package.json ./
COPY pnpm-lock.yaml ./

# 复制web子包的依赖文件
COPY minilo/apps/web/package*.json ./minilo/apps/web/

# 仅安装web子包的依赖
RUN pnpm install --filter=minilo/apps/web --frozen-lockfile --registry=https://registry.npmmirror.com --no-cache

# 复制web子包代码
COPY minilo/apps/web/ ./minilo/apps/web/

# 进入web子包目录执行打包
WORKDIR /app/minilo/apps/web
RUN echo "当前构建web子包环境: ${BUILD_ENV}"
RUN if [ "${BUILD_ENV}" = "test" ]; then \
        pnpm run build:test; \
    else \
        pnpm run build:prod; \
    fi

# 运行阶段（nginx，web专属）
FROM nginx:alpine as production-stage
ARG BUILD_ENV=prod
# 复制web打包产物
COPY --from=build-stage /app/minilo/apps/web/dist /usr/share/nginx/html
# 复制对应环境的nginx配置（可选：按环境区分）
COPY nginx-${BUILD_ENV}.conf /etc/nginx/conf.d/default.conf
EXPOSE 80
CMD ["nginx", "-g", "daemon off;"]