# -------------------------- 全局配置 --------------------------
# 运行用户（根据系统调整，如 Ubuntu 用 www-data，CentOS 用 nginx）
user www-data;
# 工作进程数（建议设为 CPU 核心数，如 2/4）
worker_processes auto;
# 错误日志路径
error_log /var/log/nginx/error.log warn;
# 进程 PID 文件
pid /var/run/nginx.pid;

# -------------------------- 事件配置 --------------------------
events {
    # 每个工作进程的最大连接数
    worker_connections 1024;
    # 启用多路复用 I/O 模型（epoll 仅 Linux 支持，性能最优）
    use epoll;
    # 每个进程同时接受多个连接
    multi_accept on;
}

# -------------------------- HTTP 核心配置（含 GZIP 核心） --------------------------
http {
    # 基础配置
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;
    charset       utf-8;

    # 日志格式
    log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                      '$status $body_bytes_sent "$http_referer" '
                      '"$http_user_agent" "$http_x_forwarded_for"';
    access_log  /var/log/nginx/access.log  main;

    # 发送文件优化（提升静态资源传输速度）
    sendfile        on;
    tcp_nopush      on;
    tcp_nodelay     on;
    # 连接超时时间
    keepalive_timeout  65;
    # 禁用服务器版本泄露
    server_tokens off;

    # ====================== GZIP 核心配置（重点提取这部分） ======================
    # 1. 启用 gzip 压缩（核心开关，必须开启）
    gzip on;

    # 2. 仅压缩大于 1KB 的文件（小于 1KB 压缩会浪费 CPU，且可能体积变大）
    gzip_min_length 1k;

    # 3. 压缩级别（1-9，推荐 6：平衡压缩率和 CPU 开销，1 最快/压缩率最低，9 最慢/压缩率最高）
    gzip_comp_level 6;

    # 4. 压缩缓冲区大小（4 个 16KB 缓冲区，适配大多数服务器内存）
    gzip_buffers 4 16k;

    # 5. 兼容 HTTP 1.0（覆盖老旧客户端，如部分移动端/代理）
    gzip_http_version 1.0;

    # 6. 禁用 IE6 及以下的 gzip（IE6 对 gzip 兼容差，易导致页面错乱）
    gzip_disable "MSIE [1-6]\.";

    # 7. 压缩内存级别（1-9，5 是平衡值，级别越高占用内存越多，压缩越快）
    gzip_mem_level 5;

    # 8. 启用动态内容压缩（如 PHP/Node.js 后端返回的动态页面、API 接口）
    # any：压缩所有代理请求；也可指定具体场景（expired/no-cache 等）
    gzip_proxied any;

    # 9. 添加 Vary 响应头（告知 CDN/代理服务器：不同编码的响应需分开缓存）
    gzip_vary on;

    # 10. 指定需要压缩的文件类型（仅文本类，避免二进制文件二次压缩）
    gzip_types
      # 基础文本类型
      text/html
      text/css
      text/plain
      text/javascript
      text/xml
      text/x-component
      # 应用层文本类型
      application/javascript
      application/x-javascript
      application/json
      application/xml
      application/xml+rss
      application/xhtml+xml
      application/x-font-ttf
      application/vnd.ms-fontobject
      # 字体/矢量图（文本格式，压缩效果好）
      font/ttf
      font/opentype
      font/x-woff
      image/svg+xml;

    # 11. 排除已压缩文件（避免图片/视频/ZIP 等二次压缩，浪费 CPU）
    map $request_filename $gzip_exclude {
        ~*\.(jpg|jpeg|png|gif|ico|bmp|webp|mp4|mp3|avi|flv|zip|rar|7z|gz)$ 1;
        default 0;
    }
    gzip_disable $gzip_exclude;
    # ====================== GZIP 配置结束 ======================

    # -------------------------- 示例站点配置 --------------------------
    server {
        # 监听端口（HTTP）
        listen 80;
        # 站点域名（替换为你的域名，如 www.example.com）
        server_name example.com www.example.com;

        # 强制 HTTPS（可选，生产环境推荐）
        # return 301 https://$host$request_uri;

        # 静态资源根目录（替换为你的项目路径）
        root /var/www/example.com;
        index index.html index.htm;

        # 静态资源缓存配置（配合 gzip 提升性能）
        location ~* \.(html|css|js|json|svg|xml)$ {
            expires 7d;        # 缓存 7 天
            add_header Cache-Control "public, max-age=604800";
        }

        # 字体文件缓存
        location ~* \.(ttf|woff|eot)$ {
            expires 30d;
            add_header Cache-Control "public, max-age=2592000";
        }

        # 二进制文件（不压缩，直接缓存）
        location ~* \.(jpg|jpeg|png|gif|webp)$ {
            expires 30d;
            add_header Cache-Control "public, max-age=2592000";
            # 禁用 gzip（二进制文件无需压缩）
            gzip off;
        }

        # 反向代理示例（如代理 Node.js/PHP 后端，gzip 已压缩动态内容）
        location /api/ {
            proxy_pass http://127.0.0.1:3000/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }
    }

    # HTTPS 示例配置（可选，生产环境推荐）
    # server {
    #     listen 443 ssl http2;
    #     server_name example.com www.example.com;
    #
    #     # SSL 证书路径（替换为你的证书）
    #     ssl_certificate /etc/nginx/ssl/example.com.crt;
    #     ssl_certificate_key /etc/nginx/ssl/example.com.key;
    #
    #     # SSL 优化
    #     ssl_protocols TLSv1.2 TLSv1.3;
    #     ssl_ciphers ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES256-GCM-SHA384;
    #     ssl_prefer_server_ciphers on;
    #     ssl_session_cache shared:SSL:10m;
    #     ssl_session_timeout 10m;
    #
    #     # 静态资源根目录
    #     root /var/www/example.com;
    #     index index.html;
    # }
}